<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>기자재 대여 신청</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .step-active { background-color: #1D4ED8; color: white; }
    .step-inactive { background-color: #e5e7eb; color: #6b7280; }
    .tab-button.active { background-color: #dbeafe; font-weight: 600; }
    .equipment-card {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      background-color: white;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
    }
    .equipment-card img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      flex-shrink: 0;
    }
    .equipment-card.disabled {
      opacity: 0.4;
      pointer-events: none;
      background-color: #f3f4f6;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-4xl mx-auto p-6 bg-white mt-6 rounded-lg shadow-md">
    <!-- 탭 -->
    <div class="flex space-x-4 mb-4">
      <button id="equipmentTab" class="tab-button active" onclick="switchTab('equipment')">장비 대여</button>
      <button id="editingRoomTab" class="tab-button" onclick="switchTab('editingRoom')">편집실 대여</button>
    </div>

    <!-- 장비 선택 -->
    <div id="equipmentForm">
      <h3 class="text-xl font-bold mb-4">장비 선택</h3>
      <select id="equipmentSelect" class="mb-4 p-2 border rounded">
        <option value="camera">카메라</option>
        <option value="lighting">조명</option>
        <option value="sound">사운드</option>
        <option value="monitor">모니터</option>
      </select>

      <label for="startDate" class="block">대여 시작일</label>
      <input type="date" id="startDate" class="p-2 border rounded mb-4">

      <label for="endDate" class="block">반납일</label>
      <input type="date" id="endDate" class="p-2 border rounded mb-4">
    </div>

    <!-- 편집실 선택 -->
    <div id="editingRoomForm" class="hidden">
      <h3 class="text-xl font-bold mb-4">편집실 대여</h3>
      <label for="editingRoomDate" class="block">대여일</label>
      <input type="date" id="editingRoomDate" class="p-2 border rounded mb-4">

      <label for="editingRoomTime" class="block">대여 시간</label>
      <input type="time" id="editingRoomTime" class="p-2 border rounded mb-4">
    </div>

    <!-- 제출 버튼 -->
    <button id="submitBtn" class="bg-blue-600 text-white px-4 py-2 rounded mt-6">신청</button>
  </div>

  <!-- 대여 신청 내역 표시 영역 -->
  <div id="rentalList" class="mt-6">
    <h3 class="text-xl font-bold mb-4">신청 내역</h3>
    <div id="rentalItems" class="space-y-4"></div>
  </div>

  <script>
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyDqGToBXgmqiOBMpFSkKZOtbo4o5sCNjuQ",
      authDomain: "yonseirent-setup.firebaseapp.com",
      projectId: "yonseirent-setup",
      storageBucket: "yonseirent-setup.firebasestorage.app",
      messagingSenderId: "1072524969376",
      appId: "1:1072524969376:web:33d1c55ca9f08da93e10c5",
      measurementId: "G-8G1D43NXMW"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 탭 전환 함수
    function switchTab(tab) {
      if (tab === 'equipment') {
        document.getElementById('equipmentForm').classList.remove('hidden');
        document.getElementById('editingRoomForm').classList.add('hidden');
        document.getElementById('equipmentTab').classList.add('active');
        document.getElementById('editingRoomTab').classList.remove('active');
      } else {
        document.getElementById('equipmentForm').classList.add('hidden');
        document.getElementById('editingRoomForm').classList.remove('hidden');
        document.getElementById('equipmentTab').classList.remove('active');
        document.getElementById('editingRoomTab').classList.add('active');
      }
    }

    // Firebase에서 대여 신청 내역을 불러오는 함수
    function loadRentalItems() {
      const rentalItemsDiv = document.getElementById('rentalItems');
      rentalItemsDiv.innerHTML = '<p>대여 내역을 불러오는 중...</p>';
      
      db.collection('rentals').orderBy('createdAt', 'desc').get().then(snapshot => {
        rentalItemsDiv.innerHTML = ''; // 초기 로딩 메시지 제거
        
        if (snapshot.empty) {
          rentalItemsDiv.innerHTML = '<p>등록된 대여 신청 내역이 없습니다.</p>';
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const rentalItem = document.createElement('div');
          rentalItem.className = 'card p-4';

          rentalItem.innerHTML = `
            <h4 class="font-semibold text-lg">${data.equipment || data.category}</h4>
            <p><strong>대여 시작일:</strong> ${data.startDate || data.editingRoomDate}</p>
            <p><strong>반납일:</strong> ${data.endDate || data.editingRoomTime}</p>
            <p><strong>상태:</strong> <span class="${data.status === '승인' ? 'text-green-600' : 'text-red-600'}">${data.status}</span></p>
          `;

          rentalItemsDiv.appendChild(rentalItem);
        });
      }).catch(error => {
        console.error('데이터 불러오기 오류:', error);
        rentalItemsDiv.innerHTML = '<p>대여 내역을 불러오는 중 오류가 발생했습니다.</p>';
      });
    }

    // 제출 버튼 클릭 시 처리
    document.getElementById('submitBtn').onclick = function() {
      const selectedCategory = document.getElementById('equipmentTab').classList.contains('active') ? 'equipment' : 'editingRoom';
      const data = selectedCategory === 'equipment' ? getEquipmentData() : getEditingRoomData();

      // Firebase에 데이터 추가
      firebase.firestore().collection('rentals').add(data)
        .then(() => {
          alert('신청이 완료되었습니다!');
          loadRentalItems(); // 신청 완료 후 대여 내역을 새로 고침
        })
        .catch(error => {
          console.error('신청 오류:', error);
          alert('신청 실패');
        });
    }

    // 장비 대여 데이터 처리
    function getEquipmentData() {
      return {
        category: 'equipment',
        equipment: document.getElementById('equipmentSelect').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        status: '대기',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()  // 서버에서 타임스탬프 생성
      };
    }

    // 편집실 대여 데이터 처리
    function getEditingRoomData() {
      return {
        category: 'editingRoom',
        editingRoomDate: document.getElementById('editingRoomDate').value,
        editingRoomTime: document.getElementById('editingRoomTime').value,
        status: '대기',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()  // 서버에서 타임스탬프 생성
      };
    }

    // 페이지 로드 시 대여 내역을 불러옵니다.
    loadRentalItems(); // 대여 내역 불러오기
  </script>
</body>
</html>
