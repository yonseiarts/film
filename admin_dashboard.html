<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  
  <!-- Firebase SDK ëª¨ë“ˆí˜• -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyDqGToBXgmqiOBMpFSkKZOtbo4o5sCNjuQ",
      authDomain: "yonseirent-setup.firebaseapp.com",
      projectId: "yonseirent-setup",
      storageBucket: "yonseirent-setup.appspot.com",
      messagingSenderId: "1072524969376",
      appId: "1:1072524969376:web:e23491a7196f97fd3e10c5",
      measurementId: "G-P61J7CYTWZ"
    };

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
  </script>
  
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <style>
    #debug-panel {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 300px;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(0,0,0,0.8);
      color: #00ff00;
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      z-index: 9999;
    }
    .hidden {
      display: none;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="bg-white p-4 rounded-lg shadow mb-6">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold">ğŸ¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        <div id="auth-status"></div>
      </div>
    </header>

    <!-- ì•Œë¦¼ ë° ì˜¤ë¥˜ ì˜ì—­ -->
    <div id="notification-area" class="mb-6">
      <div id="loading-indicator" class="bg-blue-100 text-blue-700 p-4 rounded-lg shadow mb-2">
        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
      </div>
      <div id="error-message" class="bg-red-100 text-red-700 p-4 rounded-lg shadow mb-2 hidden"></div>
      <div id="success-message" class="bg-green-100 text-green-700 p-4 rounded-lg shadow mb-2 hidden"></div>
    </div>

    <!-- ì‹ ì²­ ëª©ë¡ ì˜ì—­ -->
    <div id="application-list" class="space-y-4">
      <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>
  </div>

  <!-- ë””ë²„ê·¸ íŒ¨ë„ -->
  <div id="debug-panel" class="hidden">
    <div class="flex justify-between items-center mb-2">
      <h3>ë””ë²„ê·¸ ì½˜ì†”</h3>
      <button id="toggle-debug" class="text-xs bg-gray-700 text-white px-2 py-1 rounded">ë‹«ê¸°</button>
    </div>
    <div id="debug-content"></div>
  </div>

  <script type="module">
    // =============== ë””ë²„ê·¸ ìœ í‹¸ë¦¬í‹° ===============
    const DEBUG = true;
    const debugPanel = document.getElementById('debug-panel');
    const debugContent = document.getElementById('debug-content');
    
    if (DEBUG) {
      debugPanel.classList.remove('hidden');
      document.getElementById('toggle-debug').addEventListener('click', () => {
        debugContent.innerHTML = '';
        debugPanel.classList.toggle('hidden');
      });
    }
    
    function debug(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}][${type.toUpperCase()}] ${message}`);
      
      if (DEBUG) {
        const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'white';
        debugContent.innerHTML += `<div style="color:${color}">[${timestamp}] ${message}</div>`;
        debugPanel.scrollTop = debugPanel.scrollHeight;
      }
    }

    // =============== UI ìœ í‹¸ë¦¬í‹° ===============
    function showLoading(show = true) {
      document.getElementById('loading-indicator').style.display = show ? 'block' : 'none';
    }
    
    function showError(message, autoHide = false) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
      
      if (autoHide) {
        setTimeout(() => {
          errorElement.classList.add('hidden');
        }, 5000);
      }
    }
    
    function showSuccess(message, autoHide = true) {
      const successElement = document.getElementById('success-message');
      successElement.textContent = message;
      successElement.classList.remove('hidden');
      
      if (autoHide) {
        setTimeout(() => {
          successElement.classList.add('hidden');
        }, 3000);
      }
    }
    
    function clearMessages() {
      document.getElementById('error-message').classList.add('hidden');
      document.getElementById('success-message').classList.add('hidden');
    }

    // =============== ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ===============
    document.addEventListener('DOMContentLoaded', function() {
      debug('í˜ì´ì§€ ë¡œë“œë¨');
      initializeApp();
    });

    async function initializeApp() {
      try {
        debug('ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì‹œì‘');
        
        // Firebase ì„¤ì •
        const firebaseConfig = {
          apiKey: "AIzaSyDqGToBXgmqiOBMpFSkKZOtbo4o5sCNjuQ",
          authDomain: "yonseirent-setup.firebaseapp.com",
          projectId: "yonseirent-setup",
          storageBucket: "yonseirent-setup.appspot.com",
          messagingSenderId: "1072524969376",
          appId: "1:1072524969376:web:e23491a7196f97fd3e10c5",
          measurementId: "G-P61J7CYTWZ"
        };

        // Firebase ì´ˆê¸°í™” í™•ì¸
        if (typeof firebase === 'undefined') {
          throw new Error('Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        
        debug('Firebase SDK ë¡œë“œë¨');
        
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
          debug('Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
          debug('Firebaseê°€ ì´ë¯¸ ì´ˆê¸°í™”ë¨');
        }
        
        // Firestore ë° Auth ì°¸ì¡° ìƒì„±
        window.db = firebase.firestore();
        window.auth = firebase.auth();
        
        debug('Firebase ì„œë¹„ìŠ¤ ì°¸ì¡° ìƒì„±ë¨');
        
        // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        auth.onAuthStateChanged(handleAuthStateChanged);
        
      } catch (error) {
        debug(`ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`, 'error');
        showError(`ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
      }
    }

    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬
    function handleAuthStateChanged(user) {
      debug(`ì¸ì¦ ìƒíƒœ ë³€ê²½: ${user ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ'}`);
      updateAuthUI(user);
      
      if (user) {
        debug(`í˜„ì¬ ì‚¬ìš©ì: ${user.email}`);
        loadApplicationData();
      } else {
        debug('ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì, ë¦¬ë””ë ‰ì…˜ ì¤€ë¹„');
        document.getElementById('application-list').innerHTML = `
          <div class="bg-yellow-100 p-4 rounded-lg shadow">
            <p class="font-medium">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <p class="mt-2">5ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
          </div>
        `;
        
        // 5ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
        setTimeout(() => {
          debug('ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜');
          window.location.href = 'admin-login.html';
        }, 5000);
      }
    }

    // ì¸ì¦ UI ì—…ë°ì´íŠ¸
    function updateAuthUI(user) {
      const authStatus = document.getElementById('auth-status');
      
      if (user) {
        authStatus.innerHTML = `
          <div class="flex items-center">
            <span class="mr-4">${user.email}</span>
            <button id="logout-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded">
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        `;
        
        document.getElementById('logout-btn').addEventListener('click', () => {
          auth.signOut()
            .then(() => {
              debug('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
              showSuccess('ì„±ê³µì ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
            })
            .catch(error => {
              debug(`ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: ${error.message}`, 'error');
              showError(`ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`);
            });
        });
      } else {
        authStatus.innerHTML = `
          <span class="text-red-600">ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ</span>
        `;
      }
    }

    // ì‹ ì²­ ë°ì´í„° ë¡œë“œ
    function loadApplicationData() {
      debug('ì‹ ì²­ ë°ì´í„° ë¡œë“œ ì‹œì‘');
      showLoading(true);
      clearMessages();
      
      try {
        // ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const unsubscribe = db.collection("applications")
          .orderBy("timestamp", "desc")
          .onSnapshot(handleDataSnapshot, handleDataError);
          
        // ë‚˜ì¤‘ì— ë¦¬ìŠ¤ë„ˆ í•´ì œê°€ í•„ìš”í•œ ê²½ìš° unsubscribe() í˜¸ì¶œ
        window.unsubscribeFromData = unsubscribe;
        
      } catch (error) {
        debug(`ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
        showLoading(false);
        showError(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        renderEmptyState(`ì˜¤ë¥˜: ${error.message}`);
      }
    }

    // ìŠ¤ëƒ…ìƒ· ë°ì´í„° ì²˜ë¦¬
    function handleDataSnapshot(snapshot) {
      debug(`ë°ì´í„° ìŠ¤ëƒ…ìƒ· ìˆ˜ì‹ : ${snapshot.size}ê°œ í•­ëª©`);
      showLoading(false);
      
      try {
        if (snapshot.empty) {
          debug('ë°ì´í„° ì—†ìŒ');
          renderEmptyState('ë“±ë¡ëœ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        renderApplicationList(snapshot);
        showSuccess(`${snapshot.size}ê°œì˜ ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, true);
        
      } catch (error) {
        debug(`ìŠ¤ëƒ…ìƒ· ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}`, 'error');
        showError(`ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
      }
    }

    // ë°ì´í„° ì˜¤ë¥˜ ì²˜ë¦¬
    function handleDataError(error) {
      debug(`Firestore ì˜¤ë¥˜: ${error.message}`, 'error');
      showLoading(false);
      showError(`ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: ${error.message}`);
      renderEmptyState(`ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
    }

    // ë¹ˆ ìƒíƒœ ë Œë”ë§
    function renderEmptyState(message) {
      const container = document.getElementById('application-list');
      container.innerHTML = `
        <div class="bg-gray-100 p-6 rounded-lg shadow text-center">
          <p class="text-gray-600">${message}</p>
        </div>
      `;
    }

    // ì‹ ì²­ ëª©ë¡ ë Œë”ë§
    function renderApplicationList(snapshot) {
      const container = document.getElementById('application-list');
      container.innerHTML = '';
      
      snapshot.forEach(doc => {
        try {
          const data = doc.data();
          const card = createApplicationCard(doc.id, data);
          container.appendChild(card);
        } catch (error) {
          debug(`í•­ëª© ë Œë”ë§ ì˜¤ë¥˜ (ID: ${doc.id}): ${error.message}`, 'error');
        }
      });
    }

    // ì‹ ì²­ ì¹´ë“œ ìƒì„±
    function createApplicationCard(docId, data) {
      const div = document.createElement('div');
      div.className = 'bg-white p-4 rounded-lg shadow';
      
      const statusClass = getStatusClass(data.status);
      
      // íƒ€ì„ìŠ¤íƒ¬í”„ í¬ë§·íŒ…
      let formattedDate = 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
      if (data.timestamp && data.timestamp.toDate) {
        const date = data.timestamp.toDate();
        formattedDate = date.toLocaleString('ko-KR');
      }
      
      div.innerHTML = `
        <div class="flex justify-between items-start">
          <h2 class="text-lg font-bold">${data.name || 'ì‹ ì²­ì ë¯¸ì…ë ¥'}</h2>
          <span class="px-2 py-1 rounded text-sm font-medium ${statusClass.bg} ${statusClass.text}">
            ${data.status || 'ëŒ€ê¸°ì¤‘'}
          </span>
        </div>
        <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
          <div>
            <p class="text-sm text-gray-600">ì‹ ì²­ì¼ì‹œ</p>
            <p class="font-medium">${formattedDate}</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">ëŒ€ì—¬ì¼ì</p>
            <p class="font-medium">${data.date || '-'}</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">ëŒ€ì—¬ì‹œê°„</p>
            <p class="font-medium">${data.time || '-'}</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">ì¥ë¹„</p>
            <p class="font-medium">${data.items?.join(", ") || 'ì—†ìŒ'}</p>
          </div>
        </div>
        <div class="mt-2">
          <p class="text-sm text-gray-600">ì¦ëª…ì‚¬ì§„</p>
          <p>${data.proofPhoto
            ? `<a href="${data.proofPhoto}" target="_blank" class="text-blue-600 underline">ë³´ê¸°</a>`
            : 'ì—†ìŒ'}</p>
        </div>
        <div class="mt-4 flex space-x-2">
          <button class="approve-btn px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded" 
                  data-id="${docId}">ìŠ¹ì¸</button>
          <button class="reject-btn px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded" 
                  data-id="${docId}">ë°˜ë ¤</button>
        </div>
      `;
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      const approveBtn = div.querySelector('.approve-btn');
      const rejectBtn = div.querySelector('.reject-btn');
      
      approveBtn.addEventListener('click', () => updateApplicationStatus(docId, 'ìŠ¹ì¸ë¨'));
      rejectBtn.addEventListener('click', () => updateApplicationStatus(docId, 'ë°˜ë ¤ë¨'));
      
      return div;
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    async function updateApplicationStatus(docId, newStatus) {
      debug(`ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œì‘: ID ${docId}, ìƒˆ ìƒíƒœ "${newStatus}"`);
      
      try {
        await db.collection("applications").doc(docId).update({
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        debug(`ìƒíƒœ ì—…ë°ì´íŠ¸ ì„±ê³µ: ID ${docId}`, 'success');
        showSuccess(`ì„±ê³µì ìœ¼ë¡œ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
      } catch (error) {
        debug(`ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
        showError(`ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    // ìƒíƒœì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ë°˜í™˜
    function getStatusClass(status) {
      switch(status) {
        case 'ìŠ¹ì¸ë¨': 
          return { bg: 'bg-green-100', text: 'text-green-800' };
        case 'ë°˜ë ¤ë¨': 
          return { bg: 'bg-red-100', text: 'text-red-800' };
        default: 
          return { bg: 'bg-yellow-100', text: 'text-yellow-800' };
      }
    }
  </script>
</body>
</html>
