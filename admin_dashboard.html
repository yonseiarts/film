<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>관리자 대시보드</title>

  <!-- Firebase (compat) SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <nav class="bg-white shadow p-4">
    <div class="max-w-6xl mx-auto flex justify-between">
      <h1 class="text-xl font-bold">관리자 대시보드</h1>
      <button id="logoutBtn" class="text-blue-600 underline">로그아웃</button>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto mt-6 p-4">
    <h2 class="text-2xl font-bold mb-4">신청 목록</h2>
    <div id="applicationList" class="space-y-4">
      <!-- 신청 목록이 실시간으로 표시됩니다 -->
    </div>
  </main>

  <script>
    // TODO: 실제 Firebase config로 교체
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Firebase 초기화
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const auth = firebase.auth();

    // 인증 상태 체크
    auth.onAuthStateChanged(user => {
      if (!user) {
        // 로그인 안 된 경우 → 로그인 페이지로
        window.location.href = "admin-login.html";
      } else {
        // 로그인된 관리자일 경우 → 신청 목록 표시
        fetchApplications();
      }
    });

    // 로그아웃 버튼
    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => {
        window.location.href = "admin-login.html";
      });
    });

    // Firestore에서 신청 목록 실시간 구독
    function fetchApplications() {
      db.collection("applications")
        .orderBy("createdAt", "desc")
        .onSnapshot(snapshot => {
          const container = document.getElementById("applicationList");
          container.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            container.appendChild(renderApplicationItem(doc.id, data));
          });
        });
    }

    // 신청 항목을 표시하는 DOM 요소 생성
    function renderApplicationItem(docId, data) {
      const div = document.createElement("div");
      div.className = "bg-white rounded shadow p-4";

      // 장비 목록 / 편집실 여부 / 증명사진 링크 등
      const items = data.items?.join(", ") || "장비 없음";
      const date = data.date || "-";
      const time = data.time || "-";
      const proofPhoto = data.proofPhoto || "";
      const status = data.status || "대기중";

      div.innerHTML = `
        <h3 class="text-lg font-bold mb-2">${data.applicantName || "신청자 미입력"}</h3>
        <p class="text-sm">장비: ${items}</p>
        <p class="text-sm">대여일자: ${date}</p>
        <p class="text-sm">시간: ${time}</p>
        <p class="text-sm">증명사진: ${
          proofPhoto 
            ? `<a href="${proofPhoto}" target="_blank" class="text-blue-600 underline">보기</a>` 
            : "없음"
        }</p>
        <p class="text-sm">상태: <span class="font-semibold">${status}</span></p>
        <div class="mt-3 space-x-2">
          <button class="bg-green-500 text-white px-3 py-1 rounded" onclick="approveApplication('${docId}')">승인</button>
          <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="rejectApplication('${docId}')">반려</button>
        </div>
      `;

      return div;
    }

    // 승인 처리
    function approveApplication(docId) {
      db.collection("applications").doc(docId).update({
        status: "승인됨"
      });
    }

    // 반려 처리
    function rejectApplication(docId) {
      db.collection("applications").doc(docId).update({
        status: "반려됨"
      });
    }
  </script>
</body>
</html>
