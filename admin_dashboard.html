<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>관리자 대시보드</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .step-active { background-color: #1D4ED8; color: white; }
    .step-inactive { background-color: #e5e7eb; color: #6b7280; }
    .tab-button.active { background-color: #dbeafe; font-weight: 600; }
    .equipment-card {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      background-color: white;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
    }
    .equipment-card img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      flex-shrink: 0;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- 헤더 -->
  <div class="bg-blue-700 text-white py-6 text-center relative">
    <a href="index.html" class="absolute left-4 top-1/2 -translate-y-1/2 transform text-white underline text-sm">홈으로</a>
    <h1 class="text-2xl font-bold">관리자 대시보드</h1>
    <p class="text-sm mt-1">기자재 대여 신청 내역을 관리합니다.</p>
  </div>

  <!-- 대시보드 컨테이너 -->
  <div class="max-w-4xl mx-auto p-6 bg-white mt-6 rounded-lg shadow-md">
    <!-- 신청 내역 -->
    <div class="mb-8">
      <h2 class="text-xl font-bold mb-4">대여 신청 목록</h2>
      <div id="application-list" class="space-y-4">
        <p class="text-sm text-gray-500">대여 신청 내역을 불러오는 중...</p>
      </div>
    </div>
  </div>

  <!-- Firebase SDK & Initialization -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqGToBXgmqiOBMpFSkKZOtbo4o5sCNjuQ",
      authDomain: "yonseirent-setup.firebaseapp.com",
      projectId: "yonseirent-setup",
      storageBucket: "yonseirent-setup.firebasestorage.app",
      messagingSenderId: "1072524969376",
      appId: "1:1072524969376:web:0d7aa9875341262f3e10c5",
      measurementId: "G-CQZEKPE02D"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function activateMenu(el) {
      document.querySelectorAll('.sidebar ul li').forEach(li => li.classList.remove('active'));
      el.classList.add('active');
    }

    let processedSubTab = "승인";
    let currentUnsubscribe = null;

    function loadData(category) {
      if (currentUnsubscribe) currentUnsubscribe(); // 기존의 구독을 취소합니다.
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = '<div class="loading">데이터 로딩 중...</div>'; // 로딩 상태 표시

      if (category === 'logins') {
        const query = db.collection('studentLogins').orderBy('timestamp', 'desc');
        currentUnsubscribe = query.onSnapshot(
          snapshot => {
            if (snapshot.empty) {
              contentArea.innerHTML = '<div class="loading">표시할 데이터가 없습니다.</div>';
              return;
            }
            let html = '';
            snapshot.forEach(doc => {
              const data = doc.data();
              html += `
                <div class="card">
                  <h3>로그인 내역</h3>
                  <p><strong>이름:</strong> ${data.name || ""}</p>
                  <p><strong>학번:</strong> ${data.studentId || ""}</p>
                  <p><strong>로그인 시간:</strong> ${data.timestamp ? data.timestamp.toDate().toLocaleString() : ""}</p>
                </div>`;
            });
            contentArea.innerHTML = html;
          },
          error => {
            console.error("데이터 가져오기 오류:", error);
            contentArea.innerHTML = '<div class="loading">데이터 로딩 중 오류가 발생했습니다.</div>';
          }
        );
      } else if (category === 'pending') {
        const query = db.collection('rentals').where('status', '==', '대기').orderBy('createdAt', 'desc');
        currentUnsubscribe = query.onSnapshot(
          snapshot => {
            if (snapshot.empty) {
              contentArea.innerHTML = '<div class="loading">표시할 데이터가 없습니다.</div>';
              return;
            }
            let html = '';
            snapshot.forEach(doc => {
              const data = doc.data();
              let rentalDate = data.rentDate || (data.startDate && data.endDate ? data.startDate + " ~ " + data.endDate : "");
              html += `
                <div class="card">
                  <h3>대여 신청 내역</h3>
                  <p><strong>이름:</strong> ${data.userName || ""}</p>
                  <p><strong>학번:</strong> ${data.studentID || ""}</p>
                  <p><strong>기자재:</strong> ${data.equipment || data.items || ""}</p>
                  <p><strong>대여 날짜:</strong> ${rentalDate}</p>
                  <p><strong>신청 시간:</strong> ${data.createdAt ? data.createdAt.toDate().toLocaleString() : ""}</p>
                  <p><strong>상태:</strong> ${data.status || ""}</p>
                  <div class="actions">
                    <button onclick="updateStatus('${doc.id}', '승인')">승인</button>
                    <button onclick="updateStatus('${doc.id}', '반려')">반려</button>
                    <button onclick="updateStatus('${doc.id}', '휴지통')">휴지통</button>
                  </div>
                </div>`;
            });
            contentArea.innerHTML = html;
          },
          error => {
            console.error("데이터 가져오기 오류:", error);
            contentArea.innerHTML = '<div class="loading">데이터 로딩 중 오류가 발생했습니다.</div>';
          }
        );
      } else if (category === 'processed') {
        contentArea.innerHTML = `
          <div class="sub-tabs" id="subTabs">
            <button id="tabApproved" class="${processedSubTab === '승인' ? 'active' : ''}" onclick="setProcessedSubTab('승인')">승인</button>
            <button id="tabRejected" class="${processedSubTab === '반려' ? 'active' : ''}" onclick="setProcessedSubTab('반려')">반려</button>
          </div>
          <div id="processedContent"><div class="loading">데이터 로딩 중...</div></div>`;
        loadProcessed();
      }
    }

    function loadProcessed() {
      const processedContent = document.getElementById('processedContent');
      processedContent.innerHTML = '<div class="loading">데이터 로딩 중...</div>';
      let query = db.collection('rentals').where('status', '==', processedSubTab).orderBy('createdAt', 'desc');
      if (currentUnsubscribe) currentUnsubscribe();
      currentUnsubscribe = query.onSnapshot(snapshot => {
        if (snapshot.empty) {
          processedContent.innerHTML = '<div class="loading">표시할 데이터가 없습니다.</div>';
          return;
        }
        let html = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          let rentalDate = data.rentDate || (data.startDate && data.endDate ? data.startDate + " ~ " + data.endDate : "");
          let indicator = data.status === "승인" ? "status-승인" : "status-반려";
          html += `
            <div class="card">
              <div class="status-indicator ${indicator}"></div>
              <h3>대여 신청 내역</h3>
              <p><strong>이름:</strong> ${data.userName || ""}</p>
              <p><strong>학번:</strong> ${data.studentID || ""}</p>
              <p><strong>기자재:</strong> ${data.equipment || data.items || ""}</p>
              <p><strong>대여 날짜:</strong> ${rentalDate}</p>
              <p><strong>신청 시간:</strong> ${data.createdAt ? data.createdAt.toDate().toLocaleString() : ""}</p>
              <p><strong>상태:</strong> ${data.status || ""}</p>
              <div class="actions">
                <button onclick="updateStatus('${doc.id}', '${data.status === '승인' ? '반려' : '승인'}')">${data.status === '승인' ? '반려' : '승인'}</button>
                <button onclick="updateStatus('${doc.id}', '휴지통')">휴지통</button>
              </div>
            </div>`;
        });
        processedContent.innerHTML = html;
      });
    }

    function setProcessedSubTab(tab) {
      processedSubTab = tab;
      document.getElementById("tabApproved").classList.toggle("active", tab === "승인");
      document.getElementById("tabRejected").classList.toggle("active", tab === "반려");
      loadProcessed();
    }

    function updateStatus(docId, newStatus) {
      if (!confirm(`상태를 '${newStatus}'(으)로 변경하시겠습니까?`)) return;
      db.collection('rentals').doc(docId).update({
        status: newStatus,
        isDeleted: false
      })
      .then(() => {
        alert('상태가 변경되었습니다.');
      })
      .catch(err => {
         console.error('상태 변경 실패:', err);
        alert('오류가 발생했습니다.');
      });
    }

    loadData('pending'); // 대기 내역 로드
  </script>
</body>
</html>
