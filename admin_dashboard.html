<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>기자재 대여 관리자 대시보드</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-button.active { background-color: #1D4ED8; color: white; }
    .tab-button.inactive { background-color: #e5e7eb; color: #6b7280; }
    .table-header { background-color: #f3f4f6; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="bg-blue-700 text-white py-6 text-center">
    <h1 class="text-2xl font-bold">기자재 대여 관리자 대시보드</h1>
    <p class="text-sm mt-1">기자재 대여 신청을 관리하고 승인/반려하세요.</p>
  </div>

  <div class="max-w-4xl mx-auto p-6 bg-white mt-6 rounded-lg shadow-md">
    <!-- 탭 -->
    <div class="flex justify-between mb-8">
      <button class="tab-button active px-4 py-2 rounded" id="tab1Btn">신청 내역</button>
      <button class="tab-button inactive px-4 py-2 rounded" id="tab2Btn">휴지통</button>
    </div>

    <!-- 신청 내역 탭 -->
    <div id="tab1" class="tab-content">
      <h2 class="text-xl font-semibold mb-4">신청 내역</h2>
      <table class="min-w-full table-auto">
        <thead class="table-header">
          <tr>
            <th class="px-4 py-2">번호</th>
            <th class="px-4 py-2">이름</th>
            <th class="px-4 py-2">장비</th>
            <th class="px-4 py-2">대여일자</th>
            <th class="px-4 py-2">상태</th>
            <th class="px-4 py-2">조치</th>
          </tr>
        </thead>
        <tbody id="applications-list">
          <!-- 신청 내역 동적으로 삽입 -->
        </tbody>
      </table>
    </div>

    <!-- 휴지통 탭 -->
    <div id="tab2" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-4">휴지통</h2>
      <table class="min-w-full table-auto">
        <thead class="table-header">
          <tr>
            <th class="px-4 py-2">번호</th>
            <th class="px-4 py-2">이름</th>
            <th class="px-4 py-2">장비</th>
            <th class="px-4 py-2">대여일자</th>
            <th class="px-4 py-2">상태</th>
            <th class="px-4 py-2">복원</th>
          </tr>
        </thead>
        <tbody id="trash-list">
          <!-- 휴지통 신청 내역 동적으로 삽입 -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDK & Initialization -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
          apiKey: "AIzaSyDqGToBXgmqiOBMpFSkKZOtbo4o5sCNjuQ",
      authDomain: "yonseirent-setup.firebaseapp.com",
      projectId: "yonseirent-setup",
      storageBucket: "yonseirent-setup.firebasestorage.app",
      messagingSenderId: "1072524969376",
      appId: "1:1072524969376:web:0d7aa9875341262f3e10c5",
      measurementId: "G-CQZEKPE02D"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 신청 내역 불러오기
    async function loadApplications(showTrash = false) {
      const q = db.collection("rentals")
        .where("isDeleted", "==", showTrash)
        .orderBy("createdAt", "desc");

      const querySnapshot = await q.get();
      const list = showTrash ? document.getElementById("trash-list") : document.getElementById("applications-list");
      list.innerHTML = "";

      if (querySnapshot.empty) {
        list.innerHTML = `<tr><td colspan="6" class="text-center text-sm text-gray-500">신청 내역이 없습니다.</td></tr>`;
        return;
      }

      querySnapshot.forEach((docSnap, index) => {
        const data = docSnap.data();
        const tr = document.createElement("tr");
        tr.className = "border-t";
        tr.innerHTML = `
          <td class="px-4 py-2">${index + 1}</td>
          <td class="px-4 py-2">${data.studentName}</td>
          <td class="px-4 py-2">${data.items.join(", ")}</td>
          <td class="px-4 py-2">${data.startDate} ~ ${data.endDate}</td>
          <td class="px-4 py-2"><span class="${data.status === '승인' ? 'text-green-600' : data.status === '반려' ? 'text-red-600' : 'text-yellow-600'} font-semibold">${data.status}</span></td>
          <td class="px-4 py-2">
            ${showTrash ? `<button onclick="restoreApplication('${docSnap.id}')" class="text-blue-500 hover:text-blue-700">복원</button>` 
                        : `<button onclick="deleteApplication('${docSnap.id}')" class="text-red-500 hover:text-red-700">삭제</button>`}
          </td>
        `;
        list.appendChild(tr);
      });
    }

    // 삭제
    window.deleteApplication = async function(docId) {
      if (confirm("정말 삭제하시겠습니까?")) {
        await db.collection("rentals").doc(docId).update({ isDeleted: true });
        alert("신청 내역이 휴지통으로 이동되었습니다.");
        loadApplications();
      }
    }

    // 복원
    window.restoreApplication = async function(docId) {
      await db.collection("rentals").doc(docId).update({ isDeleted: false });
      alert("신청 내역이 복원되었습니다.");
      loadApplications(true);
    }

    // 탭 변경
    document.getElementById("tab1Btn").addEventListener("click", () => {
      document.getElementById("tab1").classList.remove("hidden");
      document.getElementById("tab2").classList.add("hidden");
      document.getElementById("tab1Btn").classList.add("active");
      document.getElementById("tab2Btn").classList.remove("active");
      loadApplications();
    });

    document.getElementById("tab2Btn").addEventListener("click", () => {
      document.getElementById("tab1").classList.add("hidden");
      document.getElementById("tab2").classList.remove("hidden");
      document.getElementById("tab2Btn").classList.add("active");
      document.getElementById("tab1Btn").classList.remove("active");
      loadApplications(true);
    });

    // 페이지 로드 시 신청 내역 불러오기
    window.onload = () => {
      loadApplications();
    };
  </script>
</body>
</html>
