<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
  <style>
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 9999px;
      margin-right: 8px;
    }
    .bg-waiting { background-color: #d1d5db; }   /* íšŒìƒ‰ - ëŒ€ê¸° */
    .bg-approved { background-color: #34d399; }  /* ì´ˆë¡ - ìŠ¹ì¸ */
    .bg-rejected { background-color: #f87171; }  /* ë¹¨ê°• - ë°˜ë ¤ */
    .bg-returned { background-color: #1f2937; }  /* ê²€ì • - ë°˜ë‚© ì™„ë£Œ */
  </style>
  <!-- Firebase ì´ˆê¸°í™”: Firestore ë° Auth ì‚¬ìš© ì „ì— ì‹¤í–‰ -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqGToBXgmqiOBMpFSkKZOtbo4o5sCNjuQ",
      authDomain: "yonseirent-setup.firebaseapp.com",
      projectId: "yonseirent-setup",
      storageBucket: "yonseirent-setup.appspot.com",
      messagingSenderId: "1072524969376",
      appId: "1:1072524969376:web:0d7aa9875341262f3e10c5",
      measurementId: "G-CQZEKPE02D"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-blue-700 text-white py-5">
    <div class="max-w-5xl mx-auto px-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">ê¸°ìì¬ ëŒ€ì—¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
      <a href="index.html" class="text-sm underline">í™ˆìœ¼ë¡œ ì´ë™</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <!-- íƒ­ ë©”ë‰´ -->
    <div class="flex space-x-4 mb-4">
      <button id="tab-waiting" class="tab-button px-4 py-2 rounded bg-blue-100 font-semibold">ëŒ€ê¸° ë‚´ì—­</button>
      <button id="tab-trash" class="tab-button px-4 py-2 rounded bg-gray-100">íœ´ì§€í†µ</button>
    </div>

    <!-- ëŒ€ê¸° ë‚´ì—­ íƒ­ ë‚´ë¶€ -->
    <div id="waiting-content">
      <!-- ëŒ€ë¶„ë¥˜ í•„í„° (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
      <div id="waiting-filters" class="hidden flex space-x-4 mb-4">
        <button id="filter-waiting-equipment" class="subtab-button px-3 py-1 rounded">ì¥ë¹„ ì‹ ì²­</button>
        <button id="filter-waiting-editing" class="subtab-button px-3 py-1 rounded">í¸ì§‘ì‹¤ ì‹ ì²­</button>
      </div>
      <div id="waiting-list" class="grid grid-cols-1 gap-4"></div>
    </div>

    <!-- íœ´ì§€í†µ íƒ­ ë‚´ë¶€ -->
    <div id="trash-content" class="hidden">
      <!-- ëŒ€ë¶„ë¥˜ í•„í„° (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
      <div id="trash-filters" class="hidden flex space-x-4 mb-4">
        <button id="filter-trash-equipment" class="subtab-button px-3 py-1 rounded">ì¥ë¹„ ì‹ ì²­</button>
        <button id="filter-trash-editing" class="subtab-button px-3 py-1 rounded">í¸ì§‘ì‹¤ ì‹ ì²­</button>
      </div>
      <div id="trash-list" class="grid grid-cols-1 gap-4"></div>
    </div>
  </main>

  <!-- ì¹´ë“œ í…œí”Œë¦¿ (ëŒ€ê¸° ë‚´ì—­ìš©) -->
  <template id="card-template">
    <div class="card-item bg-white p-4 rounded shadow flex justify-between items-start relative">
      <div class="flex items-center">
        <div class="status-dot"></div>
        <div>
          <h3 class="font-bold text-gray-800 text-sm mb-1">ì‹ ì²­ì: <span class="user-name"></span> (<span class="student-id"></span>)</h3>
          <p class="text-xs text-gray-600">ì¥ë¹„: <span class="items"></span></p>
          <p class="text-xs text-gray-600 mt-1 date-info"></p>
          <p class="text-xs text-gray-600 mt-1 time-info hidden"></p>
        </div>
      </div>
      <div class="flex flex-col space-y-2 ml-4 text-right">
        <button class="approve-btn text-green-600 text-sm hover:underline">âœ… ìŠ¹ì¸</button>
        <button class="reject-btn text-red-500 text-sm hover:underline">âŒ ë°˜ë ¤</button>
        <button class="return-btn text-black text-sm hover:underline">ğŸ“¦ ë°˜ë‚© ì™„ë£Œ</button>
      </div>
      <button class="trash-btn absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">Ã—</button>
    </div>
  </template>

  <!-- ì¹´ë“œ í…œí”Œë¦¿ (íœ´ì§€í†µìš©) -->
  <template id="trash-template">
    <div class="card-item bg-gray-100 p-4 rounded shadow flex justify-between items-start relative">
      <div class="flex items-center">
        <div class="status-dot"></div>
        <div>
          <h3 class="font-bold text-gray-800 text-sm mb-1">ì‹ ì²­ì: <span class="user-name"></span> (<span class="student-id"></span>)</h3>
          <p class="text-xs text-gray-600">ì¥ë¹„: <span class="items"></span></p>
          <p class="text-xs text-gray-600 mt-1 date-info"></p>
          <p class="text-xs text-gray-600 mt-1 time-info hidden"></p>
        </div>
      </div>
      <div class="text-right">
        <p class="text-xs text-gray-500 mb-2">ë°˜ë‚© ì™„ë£Œì¼: <span class="returned-time"></span></p>
        <button class="restore-btn text-blue-500 text-sm hover:underline">ğŸ”„ ë³µì›</button>
      </div>
    </div>
  </template>

  <!-- Firebase ë° ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    // Firestore ë° Auth ì¸ìŠ¤í„´ìŠ¤
    const db = firebase.firestore();

    let currentTab = "waiting"; // 'waiting' ë˜ëŠ” 'trash'
    let currentType = ""; // 'equipment' ë˜ëŠ” 'editing' (ëŒ€ë¶„ë¥˜)
    
    // íƒ­ ì „í™˜
    document.getElementById("tab-waiting").addEventListener("click", () => switchTab("waiting"));
    document.getElementById("tab-trash").addEventListener("click", () => switchTab("trash"));

    // ëŒ€ë¶„ë¥˜ í•„í„° íƒ­ ì´ë²¤íŠ¸ (ëŒ€ê¸° ë‚´ì—­)
    document.getElementById("filter-waiting-equipment").addEventListener("click", () => switchType("equipment", "waiting"));
    document.getElementById("filter-waiting-editing").addEventListener("click", () => switchType("editing", "waiting"));
    // ëŒ€ë¶„ë¥˜ í•„í„° íƒ­ ì´ë²¤íŠ¸ (íœ´ì§€í†µ)
    document.getElementById("filter-trash-equipment").addEventListener("click", () => switchType("equipment", "trash"));
    document.getElementById("filter-trash-editing").addEventListener("click", () => switchType("editing", "trash"));

    function switchTab(tab) {
      currentTab = tab;
      // í•„í„° íƒ­ ì´ˆê¸°í™”
      document.getElementById("waiting-filters").classList.add("hidden");
      document.getElementById("trash-filters").classList.add("hidden");
      // íƒ­ ì½˜í…ì¸  ì „í™˜
      document.getElementById("waiting-content").classList.toggle("hidden", tab !== "waiting");
      document.getElementById("trash-content").classList.toggle("hidden", tab !== "trash");
      // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      document.getElementById("tab-waiting").classList.toggle("bg-blue-100", tab === "waiting");
      document.getElementById("tab-trash").classList.toggle("bg-gray-100", tab === "trash");
      // ëŒ€ë¶„ë¥˜ ì´ˆê¸°í™”
      currentType = "";
      loadData();
    }

    function switchType(type, tab) {
      currentType = type;
      if (tab === "waiting") {
        document.getElementById("filter-waiting-equipment").classList.remove("bg-blue-200", "bg-blue-50");
        document.getElementById("filter-waiting-editing").classList.remove("bg-blue-200", "bg-blue-50");
        document.getElementById("filter-waiting-equipment").classList.add(type === "equipment" ? "bg-blue-200" : "bg-blue-50");
        document.getElementById("filter-waiting-editing").classList.add(type === "editing" ? "bg-blue-200" : "bg-blue-50");
      } else {
        document.getElementById("filter-trash-equipment").classList.remove("bg-gray-300", "bg-gray-100");
        document.getElementById("filter-trash-editing").classList.remove("bg-gray-300", "bg-gray-100");
        document.getElementById("filter-trash-equipment").classList.add(type === "equipment" ? "bg-gray-300" : "bg-gray-100");
        document.getElementById("filter-trash-editing").classList.add(type === "editing" ? "bg-gray-300" : "bg-gray-100");
      }
      loadData();
    }

    window.addEventListener("DOMContentLoaded", () => {
      switchTab("waiting");
      // ëŒ€ë¶„ë¥˜ ì„ íƒ ì „, í•„í„° íƒ­ì€ ìˆ¨ê¹€
    });

    async function loadData() {
      // ë§Œì•½ ëŒ€ë¶„ë¥˜(currentType)ê°€ ì•„ì§ ì„ íƒë˜ì§€ ì•Šì•˜ë‹¤ë©´, í•„í„° íƒ­ì€ ìˆ¨ê¸°ê³  ë©”ì‹œì§€ë¥¼ ì¶œë ¥
      if (!currentType) {
        const listEl = currentTab === "trash" ? document.getElementById("trash-list") : document.getElementById("waiting-list");
        listEl.innerHTML = '<p class="text-sm text-gray-500">ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>';
        return;
      }
      const isEditing = currentType === "editing";
      db.collection("rentals")
        .where("trashed", "==", currentTab === "trash")
        .orderBy("createdAt", "desc")
        .get()
        .then(snapshot => {
          const listEl = currentTab === "trash" ? document.getElementById("trash-list") : document.getElementById("waiting-list");
          listEl.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const id = doc.id;
            const onlyEditing = data.items?.every(i => i.includes("í¸ì§‘ì‹¤"));
            if (onlyEditing !== isEditing) return;
            const isTrash = currentTab === "trash";
            const template = document.getElementById(isTrash ? "trash-template" : "card-template");
            const clone = template.content.cloneNode(true);
            const dot = clone.querySelector(".status-dot");
            if (data.status === "ìŠ¹ì¸") dot.classList.add("bg-approved");
            else if (data.status === "ë°˜ë ¤") dot.classList.add("bg-rejected");
            else if (data.status === "ë°˜ë‚© ì™„ë£Œ") dot.classList.add("bg-returned");
            else dot.classList.add("bg-waiting");
            clone.querySelector(".user-name").textContent = data.userName;
            clone.querySelector(".student-id").textContent = data.studentId;
            clone.querySelector(".items").textContent = (data.items || []).join(", ");
            const dateInfo = clone.querySelector(".date-info");
            dateInfo.textContent = data.editingDate
              ? `ëŒ€ì—¬ì¼: ${data.editingDate}`
              : `ëŒ€ì—¬: ${data.startDate} ~ ë°˜ë‚©: ${data.endDate}`;
            const timeInfo = clone.querySelector(".time-info");
            if (data.hours?.length && data.editingDate) {
              timeInfo.textContent = `ì‹œê°„: ${data.hours.join(", ")}ì‹œ`;
              timeInfo.classList.remove("hidden");
            }
            if (isTrash) {
              const rTime = clone.querySelector(".returned-time");
              rTime.textContent = data.returnedAt ? new Date(data.returnedAt.toDate()).toLocaleString() : "-";
              clone.querySelector(".restore-btn").onclick = () => updateField(id, { trashed: false });
            } else {
              clone.querySelector(".approve-btn").onclick = () => updateField(id, { status: "ìŠ¹ì¸" });
              clone.querySelector(".reject-btn").onclick = () => updateField(id, { status: "ë°˜ë ¤" });
              clone.querySelector(".return-btn").onclick = () => updateField(id, {
                status: "ë°˜ë‚© ì™„ë£Œ",
                returnedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              clone.querySelector(".trash-btn").onclick = () => updateField(id, { trashed: true });
            }
            listEl.appendChild(clone);
          });
        });
    }

    function updateField(id, data) {
      db.collection("rentals").doc(id).update(data).then(loadData);
    }
  </script>

  <script>
    // ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    function getUserName() {
      return document.getElementById("userName").value.trim();
    }
    function getStudentID() {
      return document.getElementById("userId").value.trim();
    }

    // ë‹¨ê³„ ì´ë™ í•¨ìˆ˜
    function goToStep(n) {
      for (let i = 1; i <= 4; i++) {
        document.getElementById("step" + i)?.classList.add("hidden");
        document.getElementById("step" + i + "Btn")?.classList.remove("step-active");
        document.getElementById("step" + i + "Btn")?.classList.add("step-inactive");
      }
      document.getElementById("step" + n)?.classList.remove("hidden");
      document.getElementById("step" + n + "Btn")?.classList.add("step-active");

      if (n === 2) {
        const editingOnly = selectedItems.every(i => i.includes("í¸ì§‘ì‹¤"));
        document.getElementById("commonDateSection").classList.toggle("hidden", editingOnly);
        document.getElementById("editingDateSection").classList.toggle("hidden", !editingOnly);
        if (editingOnly) {
          const input = document.getElementById("editingDate");
          input.removeEventListener("change", generateTimeGrid);
          input.addEventListener("change", generateTimeGrid);
          generateTimeGrid();
        }
      }
      if (n === 3) {
        document.getElementById("final-selected-items").innerHTML = selectedItems.map(i => `<li>${i}</li>`).join("");
        const editingOnly = selectedItems.every(i => i.includes("í¸ì§‘ì‹¤"));
        const start = document.getElementById("startDate")?.value || "-";
        const end = document.getElementById("endDate")?.value || "-";
        const dateText = editingOnly ? document.getElementById("editingDate").value : `${start} ~ ${end}`;
        document.getElementById("final-dates").innerText = `ëŒ€ì—¬ì¼ì: ${dateText}`;
        document.getElementById("final-time").innerText = editingOnly && selectedHours.length
          ? `ì„ íƒí•œ ì‹œê°„: ${selectedHours.sort((a, b) => a - b).join(', ')}ì‹œ` : '';
      }
    }

    function goHome() {
      location.href = "index.html";
    }

    // í¸ì§‘ì‹¤ ì‹œê°„í‘œ ìƒì„±
    function generateTimeGrid() {
      const grid = document.getElementById("timeGrid");
      grid.innerHTML = "";
      selectedHours = [];

      const date = document.getElementById("editingDate").value;
      const room = selectedItems[0];
      if (!date || !room) return;

      db.collection("rentals")
        .where("editingDate", "==", date)
        .where("items", "array-contains", room)
        .get()
        .then(snapshot => {
          const reserved = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            if (Array.isArray(data.hours)) reserved.push(...data.hours);
          });
          for (let h = 0; h < 24; h++) {
            const id = `hour-${h}`;
            const input = document.createElement("input");
            const label = document.createElement("label");
            input.type = "checkbox";
            input.id = id;
            input.value = h;
            label.htmlFor = id;
            label.innerText = `${h}:00`;
            if (reserved.includes(h)) {
              input.disabled = true;
              label.className = "bg-gray-300 text-gray-500 line-through cursor-not-allowed";
            } else {
              label.className = "bg-gray-200 cursor-pointer";
              input.addEventListener("change", () => {
                if (input.checked) selectedHours.push(h);
                else selectedHours = selectedHours.filter(v => v !== h);
              });
            }
            const wrap = document.createElement("div");
            wrap.className = "inline-block";
            wrap.appendChild(input);
            wrap.appendChild(label);
            grid.appendChild(wrap);
          }
        });
    }

    // 2ë‹¨ê³„ ìœ íš¨ì„± ê²€ì‚¬
    function validateStep2() {
      if (!getUserName() || !getStudentID()) {
        alert("ì´ë¦„ê³¼ í•™ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      const editingOnly = selectedItems.every(i => i.includes("í¸ì§‘ì‹¤"));
      if (editingOnly) {
        if (!document.getElementById("editingDate").value || selectedHours.length === 0) {
          alert("í¸ì§‘ì‹¤ ëŒ€ì—¬ì¼ìì™€ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }
      } else {
        const start = document.getElementById("startDate").value;
        const end = document.getElementById("endDate").value;
        const proof = document.getElementById("proofImage").files[0];
        if (!start || !end || !proof) {
          alert("ëŒ€ì—¬ ì‹œì‘ì¼, ë°˜ë‚©ì¼, ì¦ëª…ì‚¬ì§„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }
        const diff = (new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24);
        if (diff < 0 || diff > 3) {
          alert("ëŒ€ì—¬ ê¸°ê°„ì€ ìµœëŒ€ 3ì¼ ì´ë‚´ì—¬ì•¼ í•˜ë©°, ë°˜ë‚©ì¼ì€ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }
      }
      goToStep(3);
    }

    // ì‹ ì²­ì„œ ì œì¶œ
    function submitApplication() {
      const editingOnly = selectedItems.every(i => i.includes("í¸ì§‘ì‹¤"));
      const data = {
        items: [...selectedItems],
        userName: getUserName(),
        studentId: getStudentID(),
        startDate: "",
        endDate: "",
        editingDate: "",
        hours: [],
        status: "ëŒ€ê¸°",
        trashed: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      if (editingOnly) {
        data.editingDate = document.getElementById("editingDate").value;
        data.hours = [...selectedHours].sort((a, b) => a - b);
      } else {
        data.startDate = document.getElementById("startDate").value;
        data.endDate = document.getElementById("endDate").value;
      }
      db.collection("rentals").add(data)
        .then(() => goToStep(4))
        .catch(err => {
          console.error("ì‹ ì²­ ì‹¤íŒ¨:", err);
          alert("ì‹ ì²­ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
    }

    // íƒ­ ì „í™˜ ë° ì¤‘ë¶„ë¥˜ íƒ­ (ì¥ë¹„, ì¡°ëª… ë“±) ì´ë²¤íŠ¸ ì²˜ë¦¬
    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        currentTab = btn.dataset.tab;
        document.getElementById("cameraSubTabs").style.display = currentTab === "camera" ? "flex" : "none";
        document.getElementById("lightingSubTabs").style.display = currentTab === "lighting" ? "flex" : "none";
        currentSub = currentTab === "camera" ? "body" :
                     currentTab === "lighting" ? "light" : null;
        updateSelectedUI();
        renderEquipmentList();
      });
    });

    document.querySelectorAll(".subtab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        btn.parentElement.querySelectorAll(".subtab-button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentSub = btn.dataset.subtab;
        renderEquipmentList();
      });
    });

    // ê·œì • ë™ì˜ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    document.getElementById("agreeCheck").addEventListener("change", e => {
      const btn = document.getElementById("toStep4");
      btn.disabled = !e.target.checked;
      btn.classList.toggle("opacity-50", !e.target.checked);
    });

    window.addEventListener("DOMContentLoaded", () => {
      goToStep(1);
      updateSelectedUI();
      renderEquipmentList();
    });
  </script>

  <script>
    function getUserName() {
      return document.getElementById("userName").value.trim();
    }
    function getStudentID() {
      return document.getElementById("userId").value.trim();
    }
    function goHome() {
      location.href = "index.html";
    }
  </script>
</body>
</html>
