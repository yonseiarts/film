<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¥ë¹„ ëŒ€ì—¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <!-- Tailwind CSS CDN (ê°œë°œ ì¤‘ ì‚¬ìš©; í”„ë¡œë•ì…˜ì—ì„œëŠ” ë¹Œë“œëœ CSS ì‚¬ìš© ê¶Œì¥) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase Compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
  <style>
    /* ìƒíƒœ í‘œì‹œ ì  */
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 9999px;
      margin-right: 8px;
      display: inline-block;
    }
    .bg-waiting { background-color: #d1d5db; }   /* íšŒìƒ‰ - ëŒ€ê¸° */
    .bg-approved { background-color: #34d399; }    /* ì´ˆë¡ - ìŠ¹ì¸ */
    .bg-rejected { background-color: #f87171; }    /* ë¹¨ê°• - ë°˜ë ¤ */
    .bg-returned { background-color: #1f2937; }    /* ê²€ì • - ë°˜ë‚© ì™„ë£Œ */

    /* íƒ­ ë²„íŠ¼ */
    .tab-btn {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab-btn.active {
      border-color: #1D4ED8;
      font-weight: 600;
      color: #1D4ED8;
    }
  </style>
  <!-- Firebase ì´ˆê¸°í™” -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqGToBXgmqiOBMpFSkKZOtbo4o5sCNjuQ",
      authDomain: "yonseirent-setup.firebaseapp.com",
      projectId: "yonseirent-setup",
      storageBucket: "yonseirent-setup.appspot.com",
      messagingSenderId: "1072524969376",
      appId: "1:1072524969376:web:0d7aa9875341262f3e10c5",
      measurementId: "G-CQZEKPE02D"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- í—¤ë” -->
  <header class="bg-blue-700 text-white py-5">
    <div class="max-w-5xl mx-auto px-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">ì¥ë¹„ ëŒ€ì—¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
      <a href="index.html" class="text-sm underline">í™ˆìœ¼ë¡œ ì´ë™</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <!-- íƒ­ ë©”ë‰´ (ëŒ€ê¸°, ìŠ¹ì¸, ë°˜ë ¤, ë°˜ë‚© ì™„ë£Œ) -->
    <div class="flex space-x-4 border-b border-gray-300 mb-4">
      <button id="tab-waiting" class="tab-btn active" data-status="ëŒ€ê¸°">ëŒ€ê¸°</button>
      <button id="tab-approved" class="tab-btn" data-status="ìŠ¹ì¸">ìŠ¹ì¸</button>
      <button id="tab-rejected" class="tab-btn" data-status="ë°˜ë ¤">ë°˜ë ¤</button>
      <button id="tab-returned" class="tab-btn" data-status="ë°˜ë‚© ì™„ë£Œ">ë°˜ë‚© ì™„ë£Œ</button>
    </div>
    <!-- íƒ­ ë‚´ìš© -->
    <div id="tab-content">
      <div id="status-list" class="space-y-4"></div>
    </div>
  </main>

  <!-- ì¹´ë“œ í…œí”Œë¦¿ (ëª¨ë“  íƒ­ ê³µìš©) -->
  <template id="card-template">
    <div class="card-item bg-white p-4 rounded shadow flex justify-between items-start relative">
      <div class="flex items-center">
        <span class="status-dot"></span>
        <div>
          <h3 class="font-bold text-gray-800 text-sm mb-1">
            ì‹ ì²­ì: <span class="user-name"></span> (<span class="student-id"></span>)
          </h3>
          <p class="text-xs text-gray-600">ì‹ ì²­ í•­ëª©: <span class="items"></span></p>
          <p class="text-xs text-gray-600 mt-1 date-info"></p>
          <p class="text-xs text-gray-600 mt-1 time-info hidden"></p>
          <p class="text-xs text-gray-600 mt-1">
  <strong>ëŒ€ì—¬ ì‚¬ìœ :</strong>
  <span class="rental-reason"></span>
</p>
        </div>
      </div>
      <div class="flex flex-col space-y-2 ml-4 text-right"></div>
    </div>
  </template>

  <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    let currentStatus = "ëŒ€ê¸°"; // ì´ˆê¸° íƒ­ ìƒíƒœ

    // íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentStatus = btn.dataset.status;
        loadRentalsByStatus(currentStatus);
      });
    });

    // Firestoreì—ì„œ í•´ë‹¹ ìƒíƒœì˜ ëŒ€ì—¬ ì‹ ì²­ ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì™€ ë Œë”ë§
    async function loadRentalsByStatus(status) {
      const listEl = document.getElementById("status-list");
      listEl.innerHTML = '<p class="text-gray-500 text-sm">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
      try {
        const snapshot = await db.collection("rentals")
          .where("status", "==", status)
          .orderBy("createdAt", "desc")
          .get();
        if (snapshot.empty) {
          listEl.innerHTML = `<p class="text-gray-500 text-sm">í•´ë‹¹ ìƒíƒœì˜ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
          return;
        }
        listEl.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const id = doc.id;
          const card = createCard(id, data);
          listEl.appendChild(card);
        });
      } catch (err) {
        console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
        listEl.innerHTML = `<p class="text-red-500 text-sm">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
      }
    }

    // ì¹´ë“œ ìƒì„± í•¨ìˆ˜
    function createCard(id, data) {
      const template = document.getElementById("card-template");
      const clone = template.content.cloneNode(true);
      const dot = clone.querySelector(".status-dot");
      if (data.status === "ëŒ€ê¸°") {
        dot.classList.add("bg-waiting");
      } else if (data.status === "ìŠ¹ì¸") {
        dot.classList.add("bg-approved");
      } else if (data.status === "ë°˜ë ¤") {
        dot.classList.add("bg-rejected");
      } else if (data.status === "ë°˜ë‚© ì™„ë£Œ") {
        dot.classList.add("bg-returned");
      }
      clone.querySelector(".user-name").textContent = data.userName || "";
      clone.querySelector(".student-id").textContent = data.studentId || "";
      clone.querySelector(".items").textContent = (data.items || []).join(", ");
      const dateInfo = clone.querySelector(".date-info");
      if (data.editingDate) {
        dateInfo.textContent = `ëŒ€ê´€ì¼: ${data.editingDate}`;
      } else if (data.startDate && data.endDate) {
        dateInfo.textContent = `ëŒ€ì—¬: ${data.startDate} ~ ë°˜ë‚©: ${data.endDate}`;
      }
      const timeInfo = clone.querySelector(".time-info");
      if (data.hours && data.hours.length > 0) {
        timeInfo.textContent = `ì‹œê°„: ${data.hours.sort((a,b)=>a-b).join(", ")}ì‹œ`;
        timeInfo.classList.remove("hidden");
      }
      clone.querySelector(".rental-reason").textContent = data.rentalReason || "-";
      // ì•¡ì…˜ ë²„íŠ¼ ì˜ì—­
      const btnContainer = clone.querySelector("div.flex.flex-col.space-y-2");
      btnContainer.innerHTML = "";
      if (data.status === "ëŒ€ê¸°") {
        const approveBtn = document.createElement("button");
        approveBtn.textContent = "âœ… ìŠ¹ì¸";
        approveBtn.className = "text-green-600 text-sm hover:underline";
        approveBtn.onclick = () => updateStatus(id, "ìŠ¹ì¸");
        const rejectBtn = document.createElement("button");
        rejectBtn.textContent = "âŒ ë°˜ë ¤";
        rejectBtn.className = "text-red-500 text-sm hover:underline";
        rejectBtn.onclick = () => updateStatus(id, "ë°˜ë ¤");
        btnContainer.appendChild(approveBtn);
        btnContainer.appendChild(rejectBtn);
      } else if (data.status === "ìŠ¹ì¸") {
        const returnBtn = document.createElement("button");
        returnBtn.textContent = "ğŸ“¦ ë°˜ë‚© ì™„ë£Œ";
        returnBtn.className = "text-black text-sm hover:underline";
        returnBtn.onclick = () => updateStatus(id, "ë°˜ë‚© ì™„ë£Œ", true);
        btnContainer.appendChild(returnBtn);
      } else if (data.status === "ë°˜ë ¤" || data.status === "ë°˜ë‚© ì™„ë£Œ") {
        const restoreBtn = document.createElement("button");
        restoreBtn.textContent = "ğŸ”„ ë³µì›";
        restoreBtn.className = "text-blue-500 text-sm hover:underline";
        restoreBtn.onclick = () => updateStatus(id, "ëŒ€ê¸°");
        btnContainer.appendChild(restoreBtn);
      }
      return clone;
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë°˜ë‚© ì™„ë£Œ ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€ ì˜µì…˜)
    function updateStatus(docId, newStatus, includeTimestamp = false) {
      let updateData = { status: newStatus };
      if (includeTimestamp && newStatus === "ë°˜ë‚© ì™„ë£Œ") {
        updateData.returnedAt = firebase.firestore.FieldValue.serverTimestamp();
      }
      db.collection("rentals").doc(docId).update(updateData)
        .then(() => {
          alert("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadRentalsByStatus(currentStatus);
        })
        .catch(err => {
          console.error("ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", err);
          alert("ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° íƒ­ ë°ì´í„° ë¡œë”©
    document.addEventListener("DOMContentLoaded", () => {
      loadRentalsByStatus(currentStatus);
    });
  </script>
</body>
</html>
