<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>기자재 대여 신청</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-button.active { background-color: #3b82f6; color: white; font-weight: 600; }
    .subtab-button.active { background-color: #dbeafe; font-weight: 600; }
    .equipment-card { border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; background-color: white; }
    .step { display: none; }
    .step.active { display: block; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 p-6">
  <h1 class="text-2xl font-bold mb-4">🎬 기자재 대여 신청</h1>

  <!-- STEP 1: 장비 선택 -->
  <div id="step1" class="step active">
    <h2 class="text-xl font-semibold mb-2">1단계: 장비 선택</h2>
    <div class="flex flex-wrap gap-2 mb-4">
      <button class="tab-button active px-4 py-2 rounded" data-tab="camera">카메라</button>
      <button class="tab-button px-4 py-2 rounded" data-tab="lighting">조명</button>
      <button class="tab-button px-4 py-2 rounded" data-tab="sound">사운드</button>
      <button class="tab-button px-4 py-2 rounded" data-tab="monitor">모니터</button>
      <button class="tab-button px-4 py-2 rounded" data-tab="editing">편집실</button>
      <button class="tab-button px-4 py-2 rounded" data-tab="line">라인</button>
    </div>

    <div id="cameraSubTabs" class="flex gap-2 mb-4">
      <button class="subtab-button active px-3 py-1 rounded text-sm" data-subtab="body">바디</button>
      <button class="subtab-button px-3 py-1 rounded text-sm" data-subtab="lens">렌즈</button>
      <button class="subtab-button px-3 py-1 rounded text-sm" data-subtab="tripod">삼각대</button>
    </div>

    <div id="equipmentList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    <div class="mt-6 flex justify-end">
      <button onclick="goToStep(2)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">다음 단계 →</button>
    </div>
  </div>
  <!-- STEP 2: 대여일 선택 -->
  <div id="step2" class="step">
    <h2 class="text-xl font-semibold mb-4">2단계: 대여일 선택</h2>
    <div id="commonDateSection">
      <label class="block mb-1 font-medium">대여 시작일</label>
      <input type="date" id="startDate" class="border p-2 rounded mb-4 w-full">
      <label class="block mb-1 font-medium">반납일</label>
      <input type="date" id="endDate" class="border p-2 rounded mb-4 w-full">
      <label class="block mb-1 font-medium">증명사진 업로드</label>
      <input type="file" id="proofImage" class="mb-4">
    </div>

    <div id="editingDateSection" class="hidden">
      <label class="block mb-1 font-medium">편집실 대여일자</label>
      <input type="date" id="editingDate" class="border p-2 rounded mb-4 w-full">
      <label class="block mb-1 font-medium">시간 선택</label>
      <div id="timeGrid" class="grid grid-cols-6 gap-2"></div>
    </div>

    <div class="mt-6 flex justify-between">
      <button onclick="goToStep(1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">← 이전</button>
      <button onclick="goToStep(3)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">다음 단계 →</button>
    </div>
  </div>

  <!-- STEP 3: 규정 동의 -->
  <div id="step3" class="step">
    <h2 class="text-xl font-semibold mb-4">3단계: 기자재 사용 규정 동의</h2>
    <div class="bg-white p-4 border rounded mb-4 h-60 overflow-y-scroll text-sm">
      <strong>기자재 대여 규정</strong><br/>
      • 대여 장비는 지정된 기간 내 반납해야 합니다.<br/>
      • 파손 또는 분실 시 전액 변상.<br/>
      • 연체 시 향후 대여 불가.<br/>
      • 편집실은 예약 시간 엄수.<br/>
      • 외부 반출 시 사전 승인 필요.<br/>
    </div>
    <label class="inline-flex items-center">
      <input type="checkbox" id="agreeCheck" class="mr-2">
      규정에 동의합니다.
    </label>
    <div class="mt-6 flex justify-between">
      <button onclick="goToStep(2)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">← 이전</button>
      <button onclick="goToStep(4)" id="submitBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" disabled>신청 완료</button>
    </div>
  </div>
  <!-- STEP 4: 완료 화면 -->
  <div id="step4" class="step text-center py-16">
    <h2 class="text-2xl font-bold text-green-600 mb-4">✅ 신청이 완료되었습니다!</h2>
    <p class="text-lg text-gray-700">선택한 장비 및 대여 정보를 확인하세요.</p>
    <div class="mt-6 text-sm text-gray-700" id="finalSummary"></div>
    <button onclick="goToStep(1)" class="mt-8 px-4 py-2 bg-gray-500 text-white rounded">처음으로</button>
  </div>

  <!-- Firebase 및 스크립트 -->
  <script type="module">
    import {{ initializeApp }} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {{ getFirestore, collection, addDoc, serverTimestamp }} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {{
      apiKey: "AIzaSyDqGToBXgmqiOBMpFSkKZOtbo4o5sCNjuQ",
      authDomain: "yonseirent-setup.firebaseapp.com",
      projectId: "yonseirent-setup",
      storageBucket: "yonseirent-setup.appspot.com",
      messagingSenderId: "1072524969376",
      appId: "1:1072524969376:web:33d1c55ca9f08da93e10c5"
    }};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 선택된 장비 임시 보관
    let currentTab = "camera";
    let currentSubTab = "body";
    const selectedItems = [];

    // 장비 렌더링
    const equipmentData = {equipment_json};  // 이 줄은 서버 렌더링 시 삽입됨
    const list = document.getElementById("equipmentList");

    function renderEquipment() {{
      list.innerHTML = "";
      const data = currentTab === "camera" ? equipmentData.camera[currentSubTab] : equipmentData[currentTab];
      data.forEach(item => {{
        const div = document.createElement("div");
        div.className = "equipment-card cursor-pointer hover:ring-2";
        div.innerHTML = `
          <img src="${{item.image}}" class="w-20 h-20 rounded mb-2">
          <p class="font-semibold">${{item.name}}</p>`;
        div.onclick = () => {{
          if (!selectedItems.includes(item.name)) {{
            selectedItems.push(item.name);
            div.classList.add("ring", "ring-yellow-400");
          }}
        }};
        list.appendChild(div);
      }});
    }}

    // 탭 변경
    document.querySelectorAll(".tab-button").forEach(btn => {{
      btn.addEventListener("click", () => {{
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentTab = btn.dataset.tab;
        currentSubTab = "body";
        document.getElementById("cameraSubTabs").style.display = (currentTab === "camera") ? "flex" : "none";
        renderEquipment();
      }});
    }});
    document.querySelectorAll(".subtab-button").forEach(btn => {{
      btn.addEventListener("click", () => {{
        document.querySelectorAll(".subtab-button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentSubTab = btn.dataset.subtab;
        renderEquipment();
      }});
    }});

    renderEquipment();

    // step 이동
    function goToStep(n) {{
      document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
      document.getElementById("step" + n).classList.add("active");
      if (n === 4) showSummary();
    }}

    // 규정 동의 체크
    document.getElementById("agreeCheck").addEventListener("change", (e) => {{
      document.getElementById("submitBtn").disabled = !e.target.checked;
    }});

    // 완료 요약 출력
    function showSummary() {{
      const summary = document.getElementById("finalSummary");
      const items = selectedItems.join(", ");
      const start = document.getElementById("startDate")?.value || "";
      const end = document.getElementById("endDate")?.value || "";
      const editDate = document.getElementById("editingDate")?.value || "";
      const date = (editDate || (start + " ~ " + end));
      summary.innerHTML = `
        <p><strong>선택 장비:</strong> ${items}</p>
        <p><strong>대여일자:</strong> ${date}</p>`;
      saveApplication(items, date);
    }}

    // Firestore 저장
    async function saveApplication(equipmentList, rentDate) {{
      try {{
        await addDoc(collection(db, "applications"), {{
          userName: "학생",
          studentID: "12345678",
          equipment: equipmentList,
          rentDate,
          status: "대기",
          isDeleted: false,
          createdAt: serverTimestamp()
        }});
      }} catch (err) {{
        alert("저장 오류: " + err.message);
      }}
    }}
  </script>
</body>
</html>
