<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>기자재 대여 신청</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqGToBXgmqiOBMpFSkKZOtbo4o5sCNjuQ",
      authDomain: "yonseirent-setup.firebaseapp.com",
      projectId: "yonseirent-setup",
      storageBucket: "yonseirent-setup.appspot.com",
      messagingSenderId: "1072524969376",
      appId: "1:1072524969376:web:33d1c55ca9f08da93e10c5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    let currentUserName = "";
    let currentStudentID = "";

    onAuthStateChanged(auth, user => {
      if (user) {
        // Assume user profile includes displayName = 이름_학번
        const [name, studentID] = user.displayName?.split("_") || ["", ""];
        currentUserName = name;
        currentStudentID = studentID;
      } else {
        alert("로그인이 필요합니다.");
        location.href = "student_login.html";
      }
    });

    window.submitApplication = async function() {
      const proofImage = document.getElementById("proofImage").files[0];
      const editingOnly = selectedItems.every(i => i.includes("편집실"));
      const rentDate = editingOnly
        ? document.getElementById("editingDate").value
        : `${document.getElementById("startDate").value} ~ ${document.getElementById("endDate").value}`;
      const equipment = selectedItems.join(", ");
      let timeSlots = selectedHours.length ? selectedHours.sort((a, b) => a - b).join(', ') : "";

      let imageUrl = "";
      if (proofImage) {
        const imageRef = ref(storage, `proofImages/${Date.now()}_${proofImage.name}`);
        await uploadBytes(imageRef, proofImage);
        imageUrl = await getDownloadURL(imageRef);
      }

      try {
        await addDoc(collection(db, "applications"), {
          userName: currentUserName,
          studentID: currentStudentID,
          equipment,
          rentDate,
          timeSlots,
          proofImage: imageUrl,
          status: "대기",
          createdAt: serverTimestamp(),
          isDeleted: false
        });
        goToStep(4);
      } catch (err) {
        alert("신청 중 오류가 발생했습니다: " + err.message);
      }
    }

    document.getElementById("toStep4").addEventListener("click", submitApplication);
  </script>
</head>
<body class="bg-gray-50">
<!-- 나머지 기존 HTML 코드는 그대로 유지됩니다. -->
