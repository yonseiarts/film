<!-- mypage.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>마이페이지</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqGToBXgmqiOBMpFSkKZOtbo4o5sCNjuQ",
      authDomain: "yonseirent-setup.firebaseapp.com",
      projectId: "yonseirent-setup",
      storageBucket: "yonseirent-setup.appspot.com",
      messagingSenderId: "1072524969376",
      appId: "1:1072524969376:web:33d1c55ca9f08da93e10c5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadApplications(showTrash = false) {
      const student = JSON.parse(localStorage.getItem("studentInfo"));
      if (!student) {
        alert("로그인이 필요합니다.");
        window.location.href = "student_login.html";
        return;
      }

      document.getElementById("studentName").textContent = student.name;
      document.getElementById("studentId").textContent = student.studentId;

      const q = query(
        collection(db, "applications"),
        where("studentID", "==", student.studentId),
        where("isDeleted", "==", showTrash),
        orderBy("createdAt", "desc")
      );

      const querySnapshot = await getDocs(q);
      const list = document.getElementById("applicationList");
      list.innerHTML = "";

      if (querySnapshot.empty) {
        list.innerHTML = `<p class="text-sm text-gray-500">${showTrash ? "휴지통이 비어 있습니다." : "신청 내역이 없습니다."}</p>`;
        return;
      }

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "relative border rounded-lg p-5 mb-6 bg-white shadow-md";

        const actions = showTrash
          ? `<button onclick="restoreApplication('${docSnap.id}')" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700 text-sm">복원</button>`
          : `<button onclick="deleteApplication('${docSnap.id}')" class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-sm">✕</button>`;

        const itemsHtml = data.items?.map?.(item => `<li>${item}</li>`).join("") ||
          data.equipment?.split(',').map(item => `<li>${item.trim()}</li>`).join("") ||
          "<li>-</li>";

        div.innerHTML = `
          ${actions}
          <h3 class="text-lg font-semibold text-blue-700 mb-2">신청 장비</h3>
          <ul class="list-disc ml-5 text-sm text-gray-800 mb-2">
            ${itemsHtml}
          </ul>
          <p class="text-sm text-gray-700 mb-1"><strong>대여일자:</strong> ${data.rentDate || data.date || "-"}</p>
          <p class="text-sm text-gray-700 mb-1"><strong>시작일:</strong> ${data.startDate || "-"}</p>
          <p class="text-sm text-gray-700 mb-1"><strong>반납일:</strong> ${data.endDate || "-"}</p>
          <p class="text-sm text-gray-700"><strong>상태:</strong> <span class="${data.status === '승인' ? 'text-green-600' : data.status === '반려' ? 'text-red-600' : 'text-yellow-600'} font-semibold">${data.status}</span></p>
        `;
        list.appendChild(div);
      });
    }

    window.deleteApplication = async function (docId) {
      if (confirm("정말 삭제하시겠습니까?")) {
        await updateDoc(doc(db, "applications", docId), { isDeleted: true });
        alert("신청 내역이 휴지통으로 이동되었습니다.");
        loadApplications();
      }
    }

    window.restoreApplication = async function (docId) {
      await updateDoc(doc(db, "applications", docId), { isDeleted: false });
      alert("신청 내역이 복원되었습니다.");
      loadApplications(true);
    }

    window.logout = function () {
      localStorage.removeItem("studentInfo");
      alert("로그아웃되었습니다.");
      window.location.href = "index.html";
    }

    window.goTrash = function () {
      loadApplications(true);
    }

    window.goMain = function () {
      loadApplications(false);
    }

    document.addEventListener("DOMContentLoaded", () => loadApplications(false));
  </script>
</head>
<body class="bg-gray-100 min-h-screen">
  <header class="bg-white shadow py-4 mb-6">
    <div class="max-w-5xl mx-auto px-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-blue-700">🎬 연세예술원 마이페이지</h1>
      <div class="flex gap-2">
        <button onclick="goMain()" class="bg-gray-100 text-gray-700 text-sm px-3 py-1 rounded hover:bg-gray-200">📄 신청내역</button>
        <button onclick="goTrash()" class="bg-gray-200 text-gray-700 text-sm px-3 py-1 rounded hover:bg-gray-300">🗑 휴지통</button>
        <button onclick="logout()" class="bg-red-500 text-white text-sm px-3 py-1 rounded hover:bg-red-600">로그아웃</button>
      </div>
    </div>
  </header>
  <main class="max-w-5xl mx-auto px-4">
    <section class="mb-6 bg-white p-6 rounded shadow">
      <h2 class="text-lg font-semibold text-gray-800 mb-2">👤 내 정보</h2>
      <p class="text-sm text-gray-700"><strong>이름:</strong> <span id="studentName">-</span></p>
      <p class="text-sm text-gray-700"><strong>학번:</strong> <span id="studentId">-</span></p>
    </section>
    <section class="bg-white p-6 rounded shadow">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">📦 나의 신청 내역</h2>
      <div id="applicationList">
        <p class="text-sm text-gray-500">신청 내역을 불러오는 중...</p>
      </div>
    </section>
  </main>
  <footer class="text-center text-sm text-gray-500 py-6 mt-10">
    ⓒ 2025 연세예술원 영화학과 | 문의: 02-1234-5678
  </footer>
</body>
</html>
